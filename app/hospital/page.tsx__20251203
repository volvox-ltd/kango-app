'use client';

import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

export default function HospitalDashboard() {
  const router = useRouter();
  const [applications, setApplications] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [hospitalUser, setHospitalUser] = useState<any>(null);

  // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
  const fetchApplications = async () => {
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      router.push('/login');
      return;
    }
    setHospitalUser(user);

    const { data, error } = await supabase
      .from('applications')
      .select(`
        *,
        nurses ( id, name, license_image_url, wallet_balance ),
        jobs!inner ( title, hourly_wage, start_time, end_time, hospital_id )
      `)
      .eq('jobs.hospital_id', user.id)
      .order('created_at', { ascending: false });

    if (error) console.error(error);
    if (data) setApplications(data);
    setLoading(false);
  };

  useEffect(() => {
    fetchApplications();
  }, [router]);

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
  const handleLogout = async () => {
    await supabase.auth.signOut();
    router.push('/login');
    router.refresh();
  };

  // 1. æ‰¿èªã™ã‚‹ï¼ˆå¿œå‹Ÿ â†’ å•†è«‡ä¸­ï¼‰
  const handleApprove = async (appId: string) => {
    if (!confirm('ã“ã®å¿œå‹Ÿè€…ã‚’æ‰¿èªã—ã¦ã€ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')) return;

    const { error } = await supabase
      .from('applications')
      .update({ status: 'negotiating' })
      .eq('id', appId);

    if (error) {
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } else {
      alert('æ‰¿èªã—ã¾ã—ãŸï¼ãƒãƒ£ãƒƒãƒˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚');
      fetchApplications();
    }
  };

  // 2. æ¡ç”¨ç¢ºå®šï¼ˆå•†è«‡ä¸­ â†’ æ¡ç”¨ï¼‰
  const handleConfirm = async (appId: string) => {
    if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¡ç”¨ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ')) return;

    const { error } = await supabase
      .from('applications')
      .update({ status: 'confirmed' })
      .eq('id', appId);

    if (error) alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    else {
      alert('æ¡ç”¨ç¢ºå®šã—ã¾ã—ãŸï¼å½“æ—¥ã®æ¥­å‹™ã‚’å¾…ã¡ã¾ã™ã€‚');
      fetchApplications();
    }
  };

  // 3. æ¥­å‹™å®Œäº†ï¼†å…¥é‡‘å‡¦ç†
  const handleComplete = async (app: any) => {
    if (!confirm('æ¥­å‹™å®Œäº†ã¨ã—ã¾ã™ã‹ï¼Ÿï¼ˆçœ‹è­·å¸«ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«å…¥é‡‘ã•ã‚Œã¾ã™ï¼‰')) return;

    const start = new Date(app.jobs.start_time).getTime();
    const end = new Date(app.jobs.end_time).getTime();
    const durationHours = (end - start) / (1000 * 60 * 60);
    const totalAmount = Math.floor(app.jobs.hourly_wage * durationHours);

    try {
      const { error: appError } = await supabase
        .from('applications')
        .update({ 
          status: 'completed',
          final_amount: totalAmount 
        })
        .eq('id', app.id);

      if (appError) throw appError;

      const { error: nurseError } = await supabase
        .from('nurses')
        .update({ wallet_balance: (app.nurses.wallet_balance || 0) + totalAmount })
        .eq('id', app.nurses.id);

      if (nurseError) throw nurseError;

      alert(`æ¥­å‹™å®Œäº†ï¼\nÂ¥${totalAmount.toLocaleString()} ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«å…¥é‡‘ã—ã¾ã—ãŸã€‚`);
      fetchApplications();

    } catch (e: any) {
      console.error(e);
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  };

  if (loading) return <div className="p-8">èª­ã¿è¾¼ã¿ä¸­...</div>;

  return (
    <div className="min-h-screen bg-gray-100 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold text-gray-800">ğŸ¥ ç—…é™¢ç”¨ãƒ»ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <span className="text-sm text-gray-500 mt-1 block">ID: {hospitalUser?.email}</span>
          </div>
          
          <div className="flex items-center gap-4">
            <button 
              onClick={handleLogout}
              className="text-gray-500 hover:text-red-600 text-sm font-bold underline"
            >
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>

            <Link 
              href="/hospital/create" 
              className="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 font-bold"
            >
              ï¼‹ æ–°è¦æ±‚äººã‚’ä½œæˆ
            </Link>
          </div>
        </div>
        
        {applications.length === 0 ? (
          <div className="bg-white p-12 rounded shadow text-center">
            <p className="text-gray-500 mb-4 text-lg">ã¾ã å¿œå‹Ÿã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            <p className="text-sm text-gray-400">
              è‡ªåˆ†ãŒä½œæˆã—ãŸæ±‚äººã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚<br/>
              ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦<br/>
              <span className="font-bold text-gray-600">ã€Œçœ‹è­·å¸«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€</span>ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦å¿œå‹Ÿã—ã¦ãã ã•ã„ã€‚
            </p>
          </div>
        ) : (
          <div className="bg-white rounded-lg shadow overflow-hidden overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ—¥ä»˜ãƒ»æ±‚äºº</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">çœ‹è­·å¸«</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {applications.map((app) => (
                  <tr key={app.id}>
                    <td className="px-6 py-4">
                      <div className="text-sm font-bold text-gray-900">{app.jobs?.title}</div>
                      <div className="text-xs text-gray-500">{new Date(app.created_at).toLocaleDateString()} å¿œå‹Ÿ</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{app.nurses?.name || 'åç„¡ã—'}</div>
                      <div className="text-xs text-gray-500">æ®‹é«˜: Â¥{(app.nurses?.wallet_balance || 0).toLocaleString()}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                       <span className={`px-2 py-1 text-xs font-bold rounded-full 
                        ${app.status === 'completed' ? 'bg-gray-800 text-white' : 
                          app.status === 'confirmed' ? 'bg-green-100 text-green-800' : 
                          app.status === 'negotiating' ? 'bg-blue-100 text-blue-800' : 
                          app.status === 'applied' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100'}`}>
                        {app.status}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      
                      {/* â˜…ã“ã“ã‚’ä¿®æ­£ãƒ»å¾©æ´»ã•ã›ã¾ã—ãŸï¼ */}
                      
                      {/* æ‰¿èªå¾…ã¡ */}
                      {app.status === 'applied' && (
                        <button 
                          onClick={() => handleApprove(app.id)}
                          className="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
                        >
                          æ‰¿èªã™ã‚‹
                        </button>
                      )}
                      
                      {/* å•†è«‡ä¸­ï¼šãƒãƒ£ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º */}
                      {app.status === 'negotiating' && (
                        <div className="flex flex-col gap-2 items-start">
                          <Link 
                            href={`/chat/${app.id}`}
                            className="text-blue-600 hover:underline text-xs font-bold flex items-center"
                          >
                            ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
                          </Link>
                          <button 
                            onClick={() => handleConfirm(app.id)}
                            className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow text-xs"
                          >
                            æ¡ç”¨ç¢ºå®šã«ã™ã‚‹
                          </button>
                        </div>
                      )}

                      {/* æ¡ç”¨ç¢ºå®šï¼šå±¥æ­´ã‚’è¦‹ã‚Œã‚‹ã‚ˆã†ã« */}
                      {app.status === 'confirmed' && (
                        <div className="flex flex-col gap-2 items-start">
                          <Link 
                            href={`/chat/${app.id}`}
                            className="text-gray-500 hover:underline text-xs flex items-center"
                          >
                            ğŸ“„ ãƒ­ã‚°ã‚’è¦‹ã‚‹
                          </Link>
                          <button 
                            onClick={() => handleComplete(app)}
                            className="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 shadow font-bold text-xs"
                          >
                            æ¥­å‹™å®Œäº†ï¼ˆå…¥é‡‘å®Ÿè¡Œï¼‰
                          </button>
                        </div>
                      )}

                      {/* å®Œäº†æ¸ˆã¿ */}
                      {app.status === 'completed' && (
                        <span className="text-green-600 font-bold">å®Œäº†æ¸ˆ âœ…</span>
                      )}

                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}